#!/bin/bash

# Initialize variables
CONFIG=""
TABLE_NAME=""
ROWS=""
GENERATE_ONLY=false
LOAD_ONLY=false

# Function to display help
function display_help {
    echo "Usage: $0 --config <config_file> --table-name <table_name> --rows <rows> [--generate-only] [--load-only]"
    echo "Short forms: -c <config_file> -t <table_name> -r <rows>"
    echo "Options:"
    echo "  -c, --config       Configuration file"
    echo "  -t, --table-name   Table name"
    echo "  -r, --rows         Number of rows"
    echo "  --generate-only    Only generate the loader file"
    echo "  --load-only        Only load data into the database"
    echo "  -h, --help         Display this help message"
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--config)
            CONFIG="$2"
            shift # past argument
            shift # past value
            ;;
        -t|--table-name)
            TABLE_NAME="$2"
            shift # past argument
            shift # past value
            ;;
        -r|--rows)
            ROWS="$2"
            shift # past argument
            shift # past value
            ;;
        --generate-only)
            GENERATE_ONLY=true
            shift # past argument
            ;;
        --load-only)
            LOAD_ONLY=true
            shift # past argument
            ;;
        -h|--help)
            display_help
            ;;
        *)
            echo "Invalid option: $1"
            display_help
            ;;
    esac
done

# Ensure that both --generate-only and --load-only are not provided simultaneously
if [ "$GENERATE_ONLY" = true ] && [ "$LOAD_ONLY" = true ]; then
    echo "Error: Cannot use --generate-only and --load-only simultaneously."
    exit 1
fi

if [ "$LOAD_ONLY" = true ]; then
    if [ -z "$CONFIG" ]; then
        echo "Error: --config parameter is required with --load-only."
        display_help
    fi
    echo "Loading the data into the database now!"
    java -jar target/benchbase-yugabyte/benchbase.jar -b featurebench -c "$CONFIG" --load=True
    exit 0
fi

if [ "$GENERATE_ONLY" = true ]; then
    if [ -z "$CONFIG" ] || [ -z "$TABLE_NAME" ] || [ -z "$ROWS" ]; then
        echo "Error: --config, --table-name, and --rows parameters are required with --generate-only."
        display_help
    fi
    echo "Generating loader file for the table"
    java -jar target/benchbase-yugabyte/benchbase.jar -b perf-dataloader -c "$CONFIG" -p tableName="$TABLE_NAME" -p rows="$ROWS" --load=True
    exit 0
fi

# Check if required parameters are provided for the default operation
if [ -z "$CONFIG" ] || [ -z "$TABLE_NAME" ] || [ -z "$ROWS" ]; then
    echo "Error: Missing required parameters."
    display_help
fi

# If no specific option is provided, do both generate and load with default config file location
echo "Generating loader file for the table"
java -jar target/benchbase-yugabyte/benchbase.jar -b perf-dataloader -c "$CONFIG" -p tableName="$TABLE_NAME" -p rows="$ROWS" --load=True

DEFAULT_CONFIG="${TABLE_NAME}_loader.yaml"

echo "Loading the data into the database now!"
java -jar target/benchbase-yugabyte/benchbase.jar -b featurebench -c "$DEFAULT_CONFIG" --load=True
