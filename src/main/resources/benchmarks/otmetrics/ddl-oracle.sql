BEGIN EXECUTE IMMEDIATE 'DROP TABLE observations CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;;
BEGIN EXECUTE IMMEDIATE 'DROP TABLE types CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;;
BEGIN EXECUTE IMMEDIATE 'DROP TABLE sessions CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;;
BEGIN EXECUTE IMMEDIATE 'DROP TABLE sources CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;;

CREATE TABLE sources (
    id INT NOT NULL,
    name VARCHAR(128) NOT NULL UNIQUE,
    comments VARCHAR(256) DEFAULT NULL,
    created_time TIMESTAMP NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE types (
    id INT NOT NULL,
    category INT NOT NULL,
    value_type INT NOT NULL,
    name VARCHAR(64) NOT NULL,
    comments VARCHAR(256) DEFAULT NULL,
    PRIMARY KEY (id),
    UNIQUE (category, name)
);

CREATE TABLE sessions (
    id INT NOT NULL,
    source_id INT NOT NULL REFERENCES sources (id),
    agent VARCHAR(32) NOT NULL,
    created_time TIMESTAMP NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE observations (
  source_id INT NOT NULL REFERENCES sources (id),
  session_id INT NOT NULL REFERENCES sessions (id),
  type_id INT NOT NULL REFERENCES types (id),
  value NUMBER(38) NOT NULL,
  created_time TIMESTAMP NOT NULL
);
CREATE INDEX idx_observations_source_session ON observations (source_id, session_id, type_id);